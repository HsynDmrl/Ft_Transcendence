# Transcendence Backend - Microservices Architecture

Bu proje **42 School Transcendence** projesi i√ßin Fastify ve Node.js kullanarak geli≈ütirilmi≈ü mikroservis mimarisidir.

## üèóÔ∏è Mimari Genel Bakƒ±≈ü

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   API Gateway    ‚îÇ
‚îÇ   (React)       ‚îÇ    ‚îÇ   (Port: 3000)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ                                  ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇAuth Service ‚îÇ                    ‚îÇUser Service‚îÇ
                ‚îÇ(Port: 3001) ‚îÇ                    ‚îÇ(Port: 3002)‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ                                  ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇFriend Service‚îÇ                   ‚îÇGame Service‚îÇ
                ‚îÇ(Port: 3003) ‚îÇ                    ‚îÇ(Port: 3004)‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ   SQLite   ‚îÇ
                            ‚îÇ  Database  ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì¶ Servisler

### 1. **Shared Library** (@transcendence/shared) ‚úÖ
- Ortak tipler ve aray√ºzler
- SQLite veritabanƒ± baƒülantƒ±sƒ±
- JWT token y√∂netimi
- Password hashing (bcrypt)
- Joi validation schemas
- Database migrations

### 2. **API Gateway** (Port: 3000) ‚úÖ
- T√ºm servislere merkezi eri≈üim noktasƒ±
- Authentication middleware
- Rate limiting ve CORS
- Service proxy'leri
- Health check endpoint'leri
- Error handling

### 3. **Authentication Service** (Port: 3001) ‚úÖ
- Kullanƒ±cƒ± kaydƒ± ve giri≈üi
- JWT token √ºretimi ve doƒürulama
- Refresh token y√∂netimi
- Online/offline durum g√ºncellemesi
- Password g√ºvenlik kontrolleri

### 4. **User Service** (Port: 3002) ‚úÖ Completed
- Kullanƒ±cƒ± profil y√∂netimi (g√∂r√ºnt√ºleme, g√ºncelleme, soft delete, restore)
- Avatar y√ºkleme ve i≈üleme (thumbnail, small, medium, large, original boyutlarƒ±)
- Sharp ile g√∂r√ºnt√º i≈üleme (JPEG sƒ±kƒ±≈ütƒ±rma, boyutlandƒ±rma, kƒ±rpma)
- Kullanƒ±cƒ± arama i≈ülevselliƒüi (relevance ranking ile)
- Online/offline durum y√∂netimi
- Oyun verileri ile entegre kullanƒ±cƒ± istatistikleri
- Y√ºklenen avatarlar i√ßin statik dosya sunumu
- Kapsamlƒ± validation ve hata y√∂netimi
- Kullanƒ±cƒ± listeleri i√ßin pagination desteƒüi
- Dosya boyutu ve tipi kontrol√º
- Eski dosya temizleme i≈ülevselliƒüi

### 5. **Friendship Service** (Port: 3003) ‚è≥ Planned
- Arkada≈ülƒ±k istekleri
- Arkada≈ü listesi y√∂netimi
- Online arkada≈ülar g√∂r√ºnt√ºleme
- Engelleme sistemi

### 6. **Game Service** (Port: 3004) ‚è≥ Planned
- Oyun odasƒ± olu≈üturma
- 1v1 ma√ß y√∂netimi
- Turnuva sistemi
- Match history
- Leaderboard

## üõ†Ô∏è Teknik Stack

- **Runtime**: Node.js (ES Modules)
- **Framework**: Fastify
- **Language**: TypeScript
- **Database**: SQLite
- **Authentication**: JWT
- **Password Hashing**: bcrypt
- **Validation**: Joi
- **File Upload**: @fastify/multipart + Sharp
- **Development**: tsx (TypeScript runner)

## üöÄ Kurulum ve √áalƒ±≈ütƒ±rma

### √ñn Gereksinimler
```bash
Node.js >= 18.0.0
npm >= 8.0.0
```

### 1. Dependencies Kurulumu
```bash
# Ana klas√∂rde
npm run install:all
```

### 2. T√ºm Servisleri √áalƒ±≈ütƒ±rma
```bash
# Development mode (t√ºm servisler)
npm run dev

# Veya tek tek servisler
npm run dev:gateway    # API Gateway
npm run dev:auth       # Auth Service  
npm run dev:user       # User Service
npm run dev:friendship # Friendship Service
npm run dev:game       # Game Service
```

### 3. Production Build
```bash
npm run build
```

## üìã API Endpoints

### API Gateway (http://localhost:3000)
```
GET    /                     # Service info
GET    /health               # Simple health check
GET    /health/detailed      # Detailed health with services
GET    /ready                # Readiness probe
GET    /live                 # Liveness probe

# Auth Routes (Proxy to Auth Service)
POST   /api/auth/register    # User registration
POST   /api/auth/login       # User login
POST   /api/auth/logout      # User logout (protected)
POST   /api/auth/refresh     # Refresh token
GET    /api/auth/me          # Get current user (protected)

# User Routes (Proxy to User Service) - Protected
GET    /api/users/getAll              # Get all users (with filtering)
GET    /api/users/getAllPaginated     # Get paginated users
GET    /api/users/:id                 # Get user by ID
POST   /api/users/add                 # Create new user (internal)
PUT    /api/users/update              # Update user
DELETE /api/users/soft-delete/:id     # Soft delete user
POST   /api/users/restore/:id         # Restore deleted user
GET    /api/users/profile             # Get own profile
PUT    /api/users/profile             # Update own profile
POST   /api/users/upload-avatar       # Upload avatar (multipart/form-data)
POST   /api/users/online              # Set online status
POST   /api/users/offline             # Set offline status
GET    /api/users/search?q=query      # Search users
GET    /api/users/stats/:id           # Get user statistics
```

### Auth Service (http://localhost:3001)
```
GET    /                     # Service info
POST   /register             # User registration
POST   /login                # User login
POST   /logout               # User logout (protected)
POST   /refresh              # Refresh access token
GET    /me                   # Get current user (protected)
POST   /validate             # Validate token (internal)
GET    /health               # Health check
```

### User Service (http://localhost:3002)
```
GET    /                          # Service info
GET    /health                    # Health check
GET    /ready                     # Readiness probe
GET    /live                      # Liveness probe

# User Management (Protected)
GET    /api/users/getAll          # Get all users (with ?active=true/false filter)
GET    /api/users/getAllPaginated # Get paginated users (?page=1&size=10&sort=field:asc)
GET    /api/users/:id             # Get user by ID
POST   /api/users/add             # Create new user (internal use)
PUT    /api/users/update          # Update user
DELETE /api/users/soft-delete/:id # Soft delete user
POST   /api/users/restore/:id     # Restore deleted user

# Profile Management (Protected)
GET    /api/users/profile         # Get own profile
PUT    /api/users/profile         # Update own profile
POST   /api/users/upload-avatar   # Upload avatar (multipart/form-data, max 5MB)

# Status Management (Protected)
POST   /api/users/online          # Set online status
POST   /api/users/offline         # Set offline status

# Search & Stats (Protected)
GET    /api/users/search          # Search users (?q=query&limit=20)
GET    /api/users/stats/:id       # Get user statistics and recent games

# Static Files
GET    /static/uploads/*          # Serve uploaded avatar files
```

## üóÑÔ∏è Database Schema

### Users Table
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  firstName TEXT NOT NULL,
  lastName TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  displayName TEXT UNIQUE,
  passwordHash TEXT NOT NULL,
  avatarUrl TEXT,
  isActive BOOLEAN DEFAULT 1,
  isOnline BOOLEAN DEFAULT 0,
  lastSeen DATETIME,
  wins INTEGER DEFAULT 0,
  losses INTEGER DEFAULT 0,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Friendships Table
```sql
CREATE TABLE friendships (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  requesterId INTEGER NOT NULL,
  addresseeId INTEGER NOT NULL,
  status TEXT CHECK(status IN ('pending', 'accepted', 'blocked')),
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (requesterId) REFERENCES users(id),
  FOREIGN KEY (addresseeId) REFERENCES users(id)
);
```

### Games Table
```sql
CREATE TABLE games (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  player1Id INTEGER NOT NULL,
  player2Id INTEGER NOT NULL,
  winner INTEGER,
  player1Score INTEGER DEFAULT 0,
  player2Score INTEGER DEFAULT 0,
  status TEXT CHECK(status IN ('waiting', 'in_progress', 'finished', 'cancelled')),
  startedAt DATETIME,
  endedAt DATETIME,
  tournamentId INTEGER,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## üîê Authentication

### JWT Token Structure
```typescript
interface JwtPayload {
  userId: number;
  email: string;
  displayName: string;
  iat?: number;
  exp?: number;
}
```

### Protected Endpoints
Korumalƒ± endpoint'ler `Authorization: Bearer <token>` header'ƒ± gerektirir.

## ‚öôÔ∏è Environment Variables

### Global (.env)
```bash
NODE_ENV=development
JWT_SECRET=transcendence-super-secret-key-change-in-production
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d
```

### API Gateway
```bash
PORT=3000
HOST=0.0.0.0
FRONTEND_URLS=http://localhost:5173,http://127.0.0.1:5173
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW=15 minutes
```

### Auth Service
```bash
PORT=3001
RATE_LIMIT_MAX=20
```

### User Service
```bash
PORT=3002
MAX_FILE_SIZE=5242880  # 5MB
UPLOAD_PATH=./uploads
```

## üß™ Testing

```bash
# API Gateway Health Check
curl http://localhost:3000/health

# User Registration
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "John",
    "lastName": "Doe", 
    "email": "john@example.com",
    "password": "SecurePass123!",
    "displayName": "johndoe"
  }'

# User Login
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "SecurePass123!"
  }'
```

## üìä Monitoring

### Health Checks
- **Simple**: `GET /health` - Basic health status
- **Detailed**: `GET /health/detailed` - Includes service dependencies
- **Ready**: `GET /ready` - Kubernetes readiness probe
- **Live**: `GET /live` - Kubernetes liveness probe

### Logging
- **Development**: Pretty formatted console logs
- **Production**: JSON formatted logs
- Request/Response logging with timing
- Error logging with stack traces

## üöß Development Status

### ‚úÖ Completed
- [x] Shared library with database and utilities
- [x] API Gateway with routing and middleware
- [x] Authentication Service with JWT
- [x] User Service with profile management and avatars
- [x] File upload handling with image processing
- [x] Database migrations and schema
- [x] Error handling and validation
- [x] Health checks and monitoring

### üöß In Progress
- [ ] Friendship Service (friend requests, lists, blocking)
- [ ] Game Service (matches, tournaments, leaderboard)

### ‚è≥ Planned
- [ ] Friendship Service
- [ ] Game Service  
- [ ] Tournament system
- [ ] Real-time features (WebSocket)
- [ ] Docker containerization
- [ ] API documentation (Swagger)

## ü§ù Contributing

1. Her servis kendi klas√∂r√ºnde baƒüƒ±msƒ±z olarak geli≈ütirilebilir
2. Shared library deƒüi≈üiklikleri t√ºm servisleri etkiler
3. TypeScript strict mode kullanƒ±lmalƒ±dƒ±r
4. API Response format'ƒ± tutarlƒ± olmalƒ±dƒ±r

## üìù API Response Format

```typescript
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}
```

## üéØ Next Steps

1. **User Service'i tamamla** - Profile management ve avatar upload
2. **Friendship Service'i olu≈ütur** - Arkada≈ülƒ±k sistemi
3. **Game Service'i olu≈ütur** - Oyun ve turnuva y√∂netimi
4. **WebSocket entegrasyonu** - Real-time features
5. **Frontend entegrasyonu** - React app ile baƒülantƒ±

---

**Not**: Bu README development sƒ±rasƒ±nda g√ºncellenecektir. Her servis tamamlandƒ±k√ßa yeni √∂zellikler ve endpoint'ler eklenecektir. 

## üöÄ Hƒ±zlƒ± Ba≈ülangƒ±√ß

### Otomatik Kurulum
```bash
# Backend dizinine git
cd transcendence-backend

# Kurulum script'ini √ßalƒ±≈ütƒ±r
node setup.js

# T√ºm servisleri ba≈ülat
npm run dev
```

### Manuel Kurulum

1. **Dependencies y√ºkle:**
```bash
cd transcendence-backend
npm install
npm run install:services
```

2. **Environment dosyasƒ±nƒ± ayarla:**
```bash
# .env dosyasƒ± zaten olu≈üturulmu≈ü
# ƒ∞steƒüe baƒülƒ± olarak .env dosyasƒ±nƒ± d√ºzenle
```

3. **T√ºm servisleri ba≈ülat:**
```bash
npm run dev
```

### Tekil Servis √áalƒ±≈ütƒ±rma

```bash
# Sadece API Gateway
npm run dev:gateway

# Sadece Auth Service
npm run dev:auth

# Sadece User Service
npm run dev:user

# Sadece Friendship Service
npm run dev:friendship

# Sadece Game Service
npm run dev:game
```

## üìã Servis Endpoints

### API Gateway (http://localhost:3000)
- `GET /health` - Health check
- `/api/auth/*` - Auth service proxy
- `/api/users/*` - User service proxy
- `/api/friendships/*` - Friendship service proxy
- `/api/games/*` - Game service proxy

### Auth Service (http://localhost:3001)
- `POST /api/auth/register` - Kullanƒ±cƒ± kaydƒ±
- `POST /api/auth/login` - Giri≈ü
- `POST /api/auth/logout` - √áƒ±kƒ±≈ü
- `POST /api/auth/refresh` - Token yenileme
- `GET /api/auth/me` - Mevcut kullanƒ±cƒ± bilgisi

### User Service (http://localhost:3002)
- `GET /api/users/profile` - Profil g√∂r√ºnt√ºleme
- `PUT /api/users/profile` - Profil g√ºncelleme
- `POST /api/users/avatar` - Avatar y√ºkleme

### Friendship Service (http://localhost:3003)
- `GET /api/friendships` - Arkada≈ü listesi
- `POST /api/friendships` - Arkada≈ülƒ±k isteƒüi g√∂nder
- `PUT /api/friendships/:id` - Arkada≈ülƒ±k isteƒüini kabul/reddet

### Game Service (http://localhost:3004)
- `GET /api/games` - Oyun listesi
- `POST /api/games` - Yeni oyun olu≈ütur
- `WS /ws` - Ger√ßek zamanlƒ± oyun ileti≈üimi

## üóÑÔ∏è Veritabanƒ±

Proje SQLite kullanƒ±r. Veritabanƒ± dosyasƒ± otomatik olarak `shared/data/transcendence.db` konumunda olu≈üturulur.

### Tablolar:
- `users` - Kullanƒ±cƒ± bilgileri
- `friendships` - Arkada≈ülƒ±k ili≈ükileri
- `games` - Oyun kayƒ±tlarƒ±
- `tournaments` - Turnuva bilgileri
- `tournament_participants` - Turnuva katƒ±lƒ±mcƒ±larƒ±

## üîß Geli≈ütirme

### Build
```bash
npm run build
```

### Production
```bash
npm run build
npm start
```

### Environment Variables

Gerekli environment deƒüi≈ükenleri `.env` dosyasƒ±nda tanƒ±mlanmƒ±≈ütƒ±r:

- `NODE_ENV` - Uygulama ortamƒ±
- `JWT_SECRET` - JWT ≈üifreleme anahtarƒ±
- `PORT` - Ana port (varsayƒ±lan: 3000)
- `FRONTEND_URLS` - ƒ∞zin verilen frontend URL'leri
- Ve diƒüerleri...

## üìÅ Proje Yapƒ±sƒ±

```
transcendence-backend/
‚îú‚îÄ‚îÄ api-gateway/          # API Gateway servisi
‚îú‚îÄ‚îÄ auth-service/         # Kimlik doƒürulama servisi
‚îú‚îÄ‚îÄ user-service/         # Kullanƒ±cƒ± y√∂netimi servisi
‚îú‚îÄ‚îÄ friendship-service/   # Arkada≈ülƒ±k servisi
‚îú‚îÄ‚îÄ game-service/         # Oyun servisi
‚îú‚îÄ‚îÄ shared/              # Ortak utilities ve types
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/    # Veritabanƒ± connection ve migrations
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/       # TypeScript type definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/       # JWT, password, validation utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ .env                 # Environment deƒüi≈ükenleri
‚îÇ   ‚îî‚îÄ‚îÄ package.json         # Ana package.json
```

## üß™ Test

Health check endpoint'leri test et:
```bash
curl http://localhost:3000/health
curl http://localhost:3001/health
curl http://localhost:3002/health
curl http://localhost:3003/health
curl http://localhost:3004/health
```

## üîí G√ºvenlik

- JWT token tabanlƒ± kimlik doƒürulama
- Rate limiting
- CORS korumasƒ±
- Helmet g√ºvenlik middleware'i
- Bcrypt ile ≈üifre hashleme

## üêõ Sorun Giderme

### Port zaten kullanƒ±mda hatasƒ±
```bash
# Port'u kontrol et
netstat -an | findstr :3000

# Process'i sonlandƒ±r (Windows)
taskkill /F /PID <PID>
```

### Database connection hatasƒ±
- `shared/data/` klas√∂r√ºn√ºn var olduƒüundan emin ol
- Veritabanƒ± dosyasƒ±nƒ±n yazma izinleri olduƒüunu kontrol et

### Service baƒülantƒ± hatasƒ±
- T√ºm servislerin ayakta olduƒüunu kontrol et
- Port √ßakƒ±≈ümasƒ± olup olmadƒ±ƒüƒ±nƒ± kontrol et

## üìù Notlar

- Proje development mode'da √ßalƒ±≈üacak ≈üekilde konfig√ºre edilmi≈ütir
- Production i√ßin JWT_SECRET'ƒ± deƒüi≈ütirin
- Database migrations otomatik olarak √ßalƒ±≈üƒ±r
- T√ºm servisler TypeScript ile yazƒ±lmƒ±≈ütƒ±r 